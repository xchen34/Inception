# L'utilisateur sous lequel Nginx va fonctionner (souvent 'www-data' pour des raisons de sécurité)
user www-data;

# Nombre de processus de travail que Nginx va lancer. 'auto' permet à Nginx de déterminer automatiquement le nombre idéal en fonction des ressources du serveur.
worker_processes auto;

# PID du processus principal de Nginx
pid /run/nginx.pid;

# Inclut les modules supplémentaires activés dans le répertoire /etc/nginx/modules-enabled/
include /etc/nginx/modules-enabled/*.conf;

events {
    # Définition du nombre maximal de connexions simultanées par processus de travail.
    worker_connections 768;
    # multi_accept on;  # Si activé, le serveur acceptera plusieurs connexions en une seule fois (par défaut, Nginx accepte les connexions une par une)
}

http {
    ##
    # Paramètres de base
    ##
    # Cette section est ajoutée depuis le fichier de configuration 'conf.d/default.conf'
    server {
        listen 443 ssl;  # Écoute sur le port 443 (port sécurisé pour HTTPS) avec SSL activé
        ssl_protocols TLSv1.2 TLSv1.3;  # Protocoles SSL/TLS autorisés (ici, TLS 1.2 et 1.3)
        ssl_certificate /etc/nginx/ssl/inception.crt;  # Chemin vers le certificat SSL
        ssl_certificate_key /etc/nginx/ssl/inception.key;  # Chemin vers la clé privée SSL

        # Répertoire racine du serveur web (le répertoire où se trouvent les fichiers de votre site)
        root /var/www/html;
        # Nom de domaine associé à ce serveur
        server_name leochen.42.fr;
        # Fichier index par défaut
        index index.php index.nginx-debian.html;

        location / {
            try_files $uri $uri/ =404;  # Essaie de servir le fichier demandé. Si non trouvé, renvoie une erreur 404.
        }

        location ~ \.php$ {  
            # Si l'URL correspond à un fichier PHP, inclut les configurations nécessaires pour traiter les fichiers PHP
            include snippets/fastcgi-php.conf;
            # Redirige la requête PHP vers un serveur FastCGI (ici, le serveur 'wordpress' sur le port 9000)
            fastcgi_pass wordpress:9000;
        }
    }  # Fin du bloc 'server'

    ##
    # Paramètres de performance et de sécurité
    ##
    sendfile on;  # Active l'utilisation de sendfile pour envoyer des fichiers de manière plus efficace.
    tcp_nopush on;  # Optimisation des performances de transmission de paquets TCP.
    tcp_nodelay on;  # Optimise la latence des connexions.
    keepalive_timeout 65;  # Délai de maintien d'une connexion ouverte.
    types_hash_max_size 2048;  # Taille maximale du cache pour les types MIME.

    # Chemin vers les types MIME
    include /etc/nginx/mime.types;
    default_type application/octet-stream;  # Type MIME par défaut pour les fichiers non spécifiés

    ##
    # Paramètres SSL
    ##
    ssl_prefer_server_ciphers on;  # Privilégie les suites de chiffrement définies par le serveur (plus sécurisé).

    ##
    # Paramètres de log
    ##
    # Définition des fichiers de log d'accès et d'erreur
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    ##
    # Paramètres Gzip
    ##
    gzip on;  # Active la compression Gzip pour les fichiers transférés
    # Les autres paramètres de compression Gzip sont commentés, mais peuvent être activés pour affiner la compression

    ##
    # Configurations des hôtes virtuels
    ##
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}